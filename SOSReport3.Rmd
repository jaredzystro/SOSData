---
title: State Of Organic Seed <br>Producer Survey
resource_files:
- www/cropped-logo-header.png
runtime: shiny
output:
  html_document:
    css: https://seedalliance.org/wp-content/themes/showcase-pro/style.css?ver=1.0.2
    highlight: null
    number_sections: no
    theme: spacelab
    toc: yes
    toc_float: yes
---

```{css, echo=FALSE}
h1{font-size:18px;}
h2{font-size:16px;}
.title {
  background-color: #2d677f;
  color:#ffffff;
  padding-right: 200px;
  padding-top: 10px;
  padding-left: 10px;
  padding-bottom: 10px;
}

.box {
  padding: 1em;
  background: white;
  border: 2px solid black;
  border-radius: 10px;
}

```

```{r message=FALSE, warning=FALSE, include=FALSE}
###############################################################################
###############################################################################
### Initialize packages, read data, set graphics constants----
# rm(list=ls())
# 
# install_or_load_pack <- function(pack){
#   # from https://nhsrcommunity.com/blog/a-simple-function-to-install-and-load-packages-in-r/
#   create.pkg <- pack[!(pack %in% installed.packages()[, "Package"])]
#   if (length(create.pkg))
#   {
#     install.packages(create.pkg, dependencies = TRUE, repos = "http://cran.us.r-project.org")
#   }
#   sapply(pack, require, character.only = TRUE)
# }
# 
# # Comment out package installation prior to deploying
# # packages <- c("survey","ggplot2","shiny","plyr","dplyr","srvyr", "sf", "spData","stringr","maps","ggiraph","shinycssloaders", "memoise", "shadowtext")
# # install_or_load_pack(packages)
# 
library(survey)
library(ggplot2)
library(shiny)
library(dplyr)
library(plyr)
library(srvyr)
library(sf)
library(spData)
library(stringr)
library(maps)
library(ggiraph)
library(shinycssloaders)
library(memoise)
library(shadowtext)

zipcode <- read.csv("zipcode.csv", as.is = TRUE)
data <- read.csv("NORA19_merged.csv")
key <- read.csv("question_labels.csv")
data2015 <- read.csv("2015SurveyData.csv", skip=2, header=TRUE)
data2010 <- read.csv("2010SurveyData.csv", skip=2, header=TRUE)

# Constant to set minimum number of responses to display
MINIMUM_N <- 3

# Constant to set plot heights in pixels
# Temporary fix until I can get a better dynamic plot sizing plan in place
PLOTHEIGHT <- 600

# Constant to set plot title wrapping
WRAPWIDTH <- 30

# Constant to set plot text size
BASESIZE <- 22

# Constant to set response label size
LABELSIZE <- 8

### Color palettes
# dummy variables to test
# input<- list()
# input$color_palette <- "default"

COLOR_PALETTE <- list()

COLOR_PALETTE$default <- list()
COLOR_PALETTE$default$Y2020 <- "#2d677f"
COLOR_PALETTE$default$Y2015 <- "#da413d"
COLOR_PALETTE$default$Y2010 <- "#73853a"

COLOR_PALETTE$colorblind <- list()
COLOR_PALETTE$colorblind$Y2020 <- "#f5793a"
COLOR_PALETTE$colorblind$Y2015 <- "#a95aa1"
COLOR_PALETTE$colorblind$Y2010 <- "#85c0f9"

COLOR_PALETTE$grayscale <- list()
COLOR_PALETTE$grayscale$Y2020 <- "#ffffff"
COLOR_PALETTE$grayscale$Y2015 <- "#bbbbbb"
COLOR_PALETTE$grayscale$Y2010 <- "#666666"

# Turn on bookmarking
shiny::enableBookmarking(store = 'url')


###############################################################################
###############################################################################
### Section for question data wrangling ----

### Q01A is year farm first certified ----
# These lines tidy it up and split into bins for plotting
data$YearsCertified <- as.numeric(data$Q01A)
# Convert to years certified
data$YearsCertified <- 2020 - data$YearsCertified
# Convert to bins
data$YearsCertified_bin <- cut(data$YearsCertified, breaks=c(0,1,3,6,10,15,20,30,1000), labels=c("<1","1 - 3","4 - 6","7 - 10", "11 - 15", "16 - 20", "21 - 30", "30+"))
data$YearsCertified_bin <- factor(data$YearsCertified_bin)

# 2015 tidy up
data2015$YearsCertified <- as.numeric(data2015$YearsCertified)
# 2015 Convert to bins
data2015$YearsCertified_bin <- cut(data2015$YearsCertified, breaks=c(0,1,3,6,10,15,20,30,1000), labels=c("<1","1 - 3","4 - 6","7 - 10", "11 - 15", "16 - 20", "21 - 30", "30+"))
data2015$YearsCertified_bin <- factor(data2015$YearsCertified_bin)

# 2010 tidy up
data2010$YearsCertified <- as.numeric(data2010$YearsCertified)
# 2010 Convert to bins
data2010$YearsCertified_bin <- cut(data2010$YearsCertified, breaks=c(0,1,3,6,10,15,20,30,1000), labels=c("<1","1 - 3","4 - 6","7 - 10", "11 - 15", "16 - 20", "21 - 30", "30+"))
data2010$YearsCertified_bin <- factor(data2010$YearsCertified_bin)

### Q05 is whether they had any veg acres ----
# Change non-responses to NA
data$GrowVegis <- ifelse (data$Q05 == "No answer" | data$Q05 == "partial complete" | data$Q05 == "skipped due to branching", NA, data$Q05)
# Convert from text to numeric -- 100 for veg, 0 for not. Probably a better way to do this...
data$GrowVegis <- ifelse (data$GrowVegis == "Some Annual Vegetable Crop Acres" | data$GrowVegis == "Some annual vegetable crop acres:", 100, 0) %>%
              as.numeric()

# Do the same for 2015 veg growing question
# Convert from text to numeric -- 100 for veg, 0 for not. Probably a better way to do this...
data2015$GrowVegis <- ifelse (data2015$GrowVegis == "Yes.", 100, 0) %>%
              as.numeric()

# Do the same for 2010 veg growing question
# Convert from text to numeric -- 100 for veg, 0 for not. Probably a better way to do this...
data2010$GrowVegis <- ifelse (data2010$GrowVegis == "Yes.", 100, 0) %>%
              as.numeric()

### Q05_2_o is vegetable acreage ----
# These lines split it into bins for plotting
# Remove missing data keys
data$VegiAcreage <- ifelse(!is.na(data$Q05_2_o) & (data$Q05_2_o == -1 | data$Q05_2_o == -2 | data$Q05_2_o == -3), NA, data$Q05_2_o)
data$VegiAcreage <- as.numeric(data$VegiAcreage)
# Convert to bins
data$VegiAcreage <- cut(data$VegiAcreage, breaks=c(0,3,10,50,80,160,480,1000000), labels=c("0.01 - 3","3.01 - 10","10.01 - 50","50.01 - 80", "80.01 - 160", "160.01 - 480", ">480"))
data$VegiAcreage <- factor(data$VegiAcreage)

# Do the same for the 2015 VegiAcreage
# Convert to bins
data2015$VegiAcreage <- cut(data2015$VegiAcreage, breaks=c(0,3,10,50,80,160,480,1000000), labels=c("0.01 - 3","3.01 - 10","10.01 - 50","50.01 - 80", "80.01 - 160", "160.01 - 480", ">480"))
data2015$VegiAcreage <- factor(data2015$VegiAcreage)

# Do the same for the 2010 VegiAcreage
# Convert to bins
data2010$VegiAcreage <- cut(data2010$VegiAcreage, breaks=c(0,3,10,50,80,160,480,1000000), labels=c("0.01 - 3","3.01 - 10","10.01 - 50","50.01 - 80", "80.01 - 160", "160.01 - 480", ">480"))
data2010$VegiAcreage <- factor(data2010$VegiAcreage)

### Q06 is whether they had any cover crop acres ----
# Change non-responses to NA
data$GrowCover <- ifelse (data$Q06 == "No answer" | data$Q06 == "partial complete" | data$Q06 == "skipped due to branching", NA, data$Q06)
# Convert from text to numeric -- 100 for cover, 0 for not. Probably a better way to do this...
data$GrowCover <- ifelse (data$GrowCover == "Some cover crop/green pasture acres" | data$GrowCover == "Some Cover Crops/Green Pasture Acres", 100, 0) %>%
              as.numeric()

# Do the same for 2015 veg growing question
# Convert from text to numeric -- 100 for cover, 0 for not. Probably a better way to do this...
data2015$GrowCover <- ifelse (data2015$GrowCover == "Yes", 100, 0) %>%
              as.numeric()

# Cover crop not asked for 2010

### Q06_2_o is cover crop acreage ----
# These lines split it into bins for plotting
# Remove missing data keys
data$CoverAcreage <- ifelse(!is.na(data$Q06_2_o) & (data$Q06_2_o == -1 | data$Q06_2_o == -2 | data$Q06_2_o == -3), NA, data$Q06_2_o)
data$CoverAcreage <- as.numeric(data$CoverAcreage)
# Convert to bins
data$CoverAcreage <- cut(data$CoverAcreage, breaks=c(0,3,10,50,80,160,480,1000000), labels=c("0.01 - 3","3.01 - 10","10.01 - 50","50.01 - 80", "80.01 - 160", "160.01 - 480", ">480"))
data$CoverAcreage <- factor(data$CoverAcreage)

# Do the same for the 2015 CoverAcreage
# Convert to bins
data2015$CoverAcreage <- cut(data2015$CoverAcres, breaks=c(0,3,10,50,80,160,480,1000000), labels=c("0.01 - 3","3.01 - 10","10.01 - 50","50.01 - 80", "80.01 - 160", "160.01 - 480", ">480"))
data2015$CoverAcreage <- factor(data2015$CoverAcreage)

# Cover crop not asked for 2010

### Q07 is whether they had any field crop acres ----
# Change non-responses to NA
data$GrowField <- ifelse (data$Q07 == "No answer" | data$Q07 == "partial complete" | data$Q07 == "skipped due to branching", NA, data$Q07)
# Convert from text to numeric -- 100 for field, 0 for not. Probably a better way to do this...
data$GrowField <- ifelse (data$GrowField == "Some field crop acres" | data$GrowField == "Some field crop acres:", 100, 0) %>% as.numeric()

# Do the same for 2015 field growing question
# Convert from text to numeric -- 100 for veg, 0 for not. Probably a better way to do this...
data2015$GrowField <- ifelse (data2015$GrowField == "Yes.", 100, 0) %>%
              as.numeric()

# Do the same for 2010 field growing question
# Convert from text to numeric -- 100 for veg, 0 for not. Probably a better way to do this...
data2010$GrowField <- ifelse (data2010$GrowField == "Yes.", 100, 0) %>%
              as.numeric()

### Q07_2_o is field crop acreage ----
# These lines split it into bins for plotting
# Remove missing data keys
data$FieldAcreage <- ifelse(!is.na(data$Q07_2_o) & (data$Q07_2_o == -1 | data$Q07_2_o == -2 | data$Q07_2_o == -3), NA, data$Q07_2_o)
data$FieldAcreage <- as.numeric(data$FieldAcreage)
# Convert to bins
data$FieldAcreage <- cut(data$FieldAcreage, breaks=c(0,3,10,50,80,160,480,1000000), labels=c("0.01 - 3","3.01 - 10","10.01 - 50","50.01 - 80", "80.01 - 160", "160.01 - 480", ">480"))
data$FieldAcreage <- factor(data$FieldAcreage)

# Do the same for the 2015 FieldAcreage
# Convert to bins
data2015$FieldAcreage <- cut(data2015$FieldAcreage, breaks=c(0,3,10,50,80,160,480,1000000), labels=c("0.01 - 3","3.01 - 10","10.01 - 50","50.01 - 80", "80.01 - 160", "160.01 - 480", ">480"))
data2015$FieldAcreage <- factor(data2015$FieldAcreage)

# Do the same for the 2010 FieldAcreage
# Convert to bins
data2010$FieldAcreage <- cut(data2010$FieldAcreage, breaks=c(0,3,10,50,80,160,480,1000000), labels=c("0.01 - 3","3.01 - 10","10.01 - 50","50.01 - 80", "80.01 - 160", "160.01 - 480", ">480"))
data2010$FieldAcreage <- factor(data2010$FieldAcreage)

### Q08 is whether they had any forage crop acres ----
# Change non-responses to NA
data$GrowForage <- ifelse (data$Q08 == "No answer" | data$Q08 == "partial complete" | data$Q08 == "skipped due to branching", NA, data$Q08)
# Convert from text to numeric -- 100 for field, 0 for not. Probably a better way to do this...
data$GrowForage <- ifelse (data$GrowForage == "Some forage crop acres" | data$GrowForage == "Some forage crop acres:", 100, 0) %>% as.numeric()

# Do the same for 2015 forage growing question
# Convert from text to numeric -- 100 for veg, 0 for not. Probably a better way to do this...
data2015$GrowForage <- ifelse (data2015$GrowForage == "Yes.", 100, 0) %>%
              as.numeric()

# Do the same for 2010 forage growing question
# Convert from text to numeric -- 100 for veg, 0 for not. Probably a better way to do this...
data2010$GrowForage <- ifelse (data2010$GrowForage == "Yes.", 100, 0) %>%
              as.numeric()

### Q08_2_o is forage crop acreage ----
# These lines split it into bins for plotting
# Remove missing data keys
data$ForageAcreage <- ifelse(!is.na(data$Q07_2_o) & (data$Q07_2_o == -1 | data$Q07_2_o == -2 | data$Q07_2_o == -3), NA, data$Q07_2_o)
data$ForageAcreage <- as.numeric(data$ForageAcreage)
# Convert to bins
data$ForageAcreage <- cut(data$ForageAcreage, breaks=c(0,3,10,50,80,160,480,1000000), labels=c("0.01 - 3","3.01 - 10","10.01 - 50","50.01 - 80", "80.01 - 160", "160.01 - 480", ">480"))
data$ForageAcreage <- factor(data$ForageAcreage)

# Do the same for the 2015 ForageAcreage
# Convert to bins
data2015$ForageAcreage <- cut(data2015$ForageAcreage, breaks=c(0,3,10,50,80,160,480,1000000), labels=c("0.01 - 3","3.01 - 10","10.01 - 50","50.01 - 80", "80.01 - 160", "160.01 - 480", ">480"))
data2015$ForageAcreage <- factor(data2015$ForageAcreage)

# Do the same for the 2010 ForageAcreage
# Convert to bins
data2010$ForageAcreage <- cut(data2010$ForageAcreage, breaks=c(0,3,10,50,80,160,480,1000000), labels=c("0.01 - 3","3.01 - 10","10.01 - 50","50.01 - 80", "80.01 - 160", "160.01 - 480", ">480"))
data2010$ForageAcreage <- factor(data2010$ForageAcreage)

### Additional variables used for filtering specifying what crop types they grow ----
data$HasVeg <- ifelse(data$GrowVegis == 100, TRUE, FALSE)
data$OnlyVeg <- ifelse(data$GrowVegis == 100 & data$GrowField == 0 & data$GrowForage == 0, TRUE, FALSE)

data$HasField <- ifelse(data$GrowField == 100, TRUE, FALSE)
data$OnlyField <- ifelse(data$GrowField == 100 & data$GrowVegis == 0 & data$GrowForage == 0, TRUE, FALSE)

data$HasForage <- ifelse(data$GrowForage == 100, TRUE, FALSE)
data$OnlyForage <- ifelse(data$GrowForage == 100 & data$GrowField == 0 & data$GrowVeg == 0, TRUE, FALSE)

data2015$HasVeg <- ifelse(data2015$GrowVegis == 100, TRUE, FALSE)
data2015$OnlyVeg <- ifelse(data2015$GrowVegis == 100 & data2015$GrowField == 0 & data2015$GrowForage == 0, TRUE, FALSE)

data2015$HasField <- ifelse(data2015$GrowField == 100, TRUE, FALSE)
data2015$OnlyField <- ifelse(data2015$GrowField == 100 & data2015$GrowVegis == 0 & data2015$GrowForage == 0, TRUE, FALSE)

data2015$HasForage <- ifelse(data2015$GrowForage == 100, TRUE, FALSE)
data2015$OnlyForage <- ifelse(data2015$GrowForage == 100 & data2015$GrowField == 0 & data2015$GrowVegis == 0, TRUE, FALSE)

# No cover crop question for 2010
data2010$HasVeg <- ifelse(data2010$GrowVegis == 100, TRUE, FALSE)
data2010$OnlyVeg <- ifelse(data2010$GrowVegis == 100 & data2010$GrowField == 0 & data2010$GrowForage == 0, TRUE, FALSE)

data2010$HasField <- ifelse(data2010$GrowField == 100, TRUE, FALSE)
data2010$OnlyField <- ifelse(data2010$GrowField == 100 & data2010$GrowVegis == 0 & data2010$GrowForage == 0, TRUE, FALSE)

data2010$HasForage <- ifelse(data2010$GrowForage == 100, TRUE, FALSE)
data2010$OnlyForage <- ifelse(data2010$GrowForage == 100 & data2010$GrowField == 0 & data2010$GrowVegis == 0, TRUE, FALSE)

### Q05aA Percent organic vegetable seed ----
data$OGVegiSeed <- as.numeric(data$Q05aA)
data2015$OGVegiSeed <- as.numeric(data2015$OGVegiSeed)
data2010$OGVegiSeed <- as.numeric(data2010$OGVegiSeed)

data$OGVegiSeed <- as.numeric(data$Q07aA) %>% ifelse (. > 100 | . < 0, NA, .)
data2015$OGVegiSeed <- as.numeric(data2015$OGVegiSeed) %>% ifelse (. > 100 | . < 0, NA, .)
data2010$OGVegiSeed <- as.numeric(data2010$OGVegiSeed) %>% ifelse (. > 100 | . < 0, NA, .)

# Add bins
data$OGVegiSeedBins <- cut(data$OGVegiSeed, breaks=c(0,0.1,10,20,30,40,50,60,70,80,90,99.9,100), labels=c("0","0.1-10","11-20","21-30", "31-40", "41-50", "51-60", "61-70", "71-80", "81-90","91-99.9","100"))
data2015$OGVegiSeedBins <- cut(data2015$OGVegiSeed, breaks=c(0,0.1,10,20,30,40,50,60,70,80,90,99.9,100), labels=c("0","0.1-10","11-20","21-30", "31-40", "41-50", "51-60", "61-70", "71-80", "81-90","91-99.9","100"))
data2010$OGVegiSeedBins <- cut(data2010$OGVegiSeed, breaks=c(0,0.1,10,20,30,40,50,60,70,80,90,99.9,100), labels=c("0","0.1-10","11-20","21-30", "31-40", "41-50", "51-60", "61-70", "71-80", "81-90","91-99.9","100"))

### Q06aA  Percent organic cover seed ----
data$OGCoverSeed <- as.numeric(data$Q06aA)
data2015$OGCoverSeed <- as.numeric(data2015$OGCoverSeed)
# No data for cover

# Add bins
data$OGCoverSeedBins <- cut(data$OGCoverSeed, breaks=c(0,0.1,10,20,30,40,50,60,70,80,90,99.9,100), labels=c("0","0.1-10","11-20","21-30", "31-40", "41-50", "51-60", "61-70", "71-80", "81-90","91-99.9","100"))
data2015$OGCoverSeedBins <- cut(data2015$OGCoverSeed, breaks=c(0,0.1,10,20,30,40,50,60,70,80,90,99.9,100), labels=c("0","0.1-10","11-20","21-30", "31-40", "41-50", "51-60", "61-70", "71-80", "81-90","91-99.9","100"))

### Q07aA  Percent organic field crop seed ----
data$OGFieldSeed <- as.numeric(data$Q07aA)
data2015$OGFieldSeed <- as.numeric(data2015$OGFieldSeed)
data2010$OGFieldSeed <- as.numeric(data2010$OGFieldSeed)

data$OGFieldSeed <- as.numeric(data$Q07aA) %>% ifelse (. > 100 | . < 0, NA, .)
data2015$OGFieldSeed <- as.numeric(data2015$OGFieldSeed) %>% ifelse (. > 100 | . < 0, NA, .)
data2010$OGFieldSeed <- as.numeric(data2010$OGFieldSeed) %>% ifelse (. > 100 | . < 0, NA, .)

# Add bins
data$OGFieldSeedBins <- cut(data$OGFieldSeed, breaks=c(0,0.1,10,20,30,40,50,60,70,80,90,99.9,100), labels=c("0","0.1-10","11-20","21-30", "31-40", "41-50", "51-60", "61-70", "71-80", "81-90","91-99.9","100"))
data2015$OGFieldSeedBins <- cut(data2015$OGFieldSeed, breaks=c(0,0.1,10,20,30,40,50,60,70,80,90,99.9,100), labels=c("0","0.1-10","11-20","21-30", "31-40", "41-50", "51-60", "61-70", "71-80", "81-90","91-99.9","100"))
data2010$OGFieldSeedBins <- cut(data2010$OGFieldSeed, breaks=c(0,0.1,10,20,30,40,50,60,70,80,90,99.9,100), labels=c("0","0.1-10","11-20","21-30", "31-40", "41-50", "51-60", "61-70", "71-80", "81-90","91-99.9","100"))

### Q08aA  Percent organic forage crop seed ----
data$OGForageSeed <- as.numeric(data$Q08aA)
data2015$OGForageSeed <- as.numeric(data2015$OGForageSeed)
data2010$OGForageSeed <- as.numeric(data2010$OGForageSeed)

data$OGForageSeed <- as.numeric(data$Q08aA) %>% ifelse (. > 100 | . < 0, NA, .)
data2015$OGForageSeed <- as.numeric(data2015$OGForageSeed) %>% ifelse (. > 100 | . < 0, NA, .)
data2010$OGForageSeed <- as.numeric(data2010$OGForageSeed) %>% ifelse (. > 100 | . < 0, NA, .)

# Add bins
data$OGForageSeedBins <- cut(data$OGForageSeed, breaks=c(0,0.1,10,20,30,40,50,60,70,80,90,99.9,100), labels=c("0","0.1-10","11-20","21-30", "31-40", "41-50", "51-60", "61-70", "71-80", "81-90","91-99.9","100"))
data2015$OGForageSeedBins <- cut(data2015$OGForageSeed, breaks=c(0,0.1,10,20,30,40,50,60,70,80,90,99.9,100), labels=c("0","0.1-10","11-20","21-30", "31-40", "41-50", "51-60", "61-70", "71-80", "81-90","91-99.9","100"))
data2010$OGForageSeedBins <- cut(data2010$OGForageSeed, breaks=c(0,0.1,10,20,30,40,50,60,70,80,90,99.9,100), labels=c("0","0.1-10","11-20","21-30", "31-40", "41-50", "51-60", "61-70", "71-80", "81-90","91-99.9","100"))

### Calculates statistic on if they use all organic seed ----
data$AllOGSeed <- ifelse((data$OGVegiSeed  == 100 | is.na(data$OGVegiSeed)) & (data$OGCoverSeed == 100 | is.na(data$OGCoverSeed)) & (data$OGFieldSeed == 100 | is.na(data$OGFieldSeed)) & (data$OGForageSeed == 100 | is.na(data$OGForageSeed)), 100,0)
data$AllOGSeed <- ifelse(is.na(data$OGVegiSeed) &  is.na(data$OGCoverSeed) & is.na(data$OGFieldSeed) & is.na(data$OGForageSeed), NA, data$AllOGSeed)

data2015$AllOGSeed <- ifelse((data2015$OGVegiSeed  == 100 | is.na(data2015$OGVegiSeed)) & (data2015$OGCoverSeed == 100 | is.na(data2015$OGCoverSeed)) & (data2015$OGFieldSeed == 100 | is.na(data2015$OGFieldSeed)) & (data2015$OGForageSeed == 100 | is.na(data2015$OGForageSeed)), 100,0)
data2015$AllOGSeed <- ifelse(is.na(data2015$OGVegiSeed) &  is.na(data2015$OGCoverSeed) & is.na(data2015$OGFieldSeed) & is.na(data2015$OGForageSeed), NA, data2015$AllOGSeed)

data2010$AllOGSeed <- ifelse((data2010$OGVegiSeed  == 100 | is.na(data2010$OGVegiSeed)) & (data2010$OGFieldSeed == 100 | is.na(data2010$OGFieldSeed)) & (data2010$OGForageSeed == 100 | is.na(data2010$OGForageSeed)), 100,0)
data2010$AllOGSeed <- ifelse(is.na(data2010$OGVegiSeed) & is.na(data2010$OGFieldSeed) & is.na(data2010$OGForageSeed), NA, data2010$AllOGSeed)


### Q26B is what percentage of seed they got from seed they saved ----
# Making a column to turn this into yes/no with 100 = yes, 0 = no
data$SeedSourceOwn0or100 <- as.numeric(data$Q26B)
data$SeedSourceOwn0or100 <- ifelse(!is.na(data$SeedSourceOwn) & data$SeedSourceOwn>0, 100, 0)

data2015$SeedSourceOwn0or100 <- ifelse(!is.na(data2015$SeedSourceOwn) & data2015$SeedSourceOwn>0, 100, 0)

data2010$SeedSourceOwn0or100 <- ifelse(!is.na(data2010$SeedSourceOwn) & data2010$SeedSourceOwn>0, 100, 0)

### Q34 is Are you interested in producing organic seed for commercial use at some point in the future? ----
# Change non-responses to NA
# Order factors
data$SeedInterest <- ifelse (data$Q34 == "No answer" | data$Q34 == "partial complete" | data$Q34 == "skipped due to branching", NA, data$Q34)
data$SeedInterest <- factor(data$SeedInterest, levels = c("Not interested", "Somewhat interested", "Interested", "Very interested"))

# 2015 Seed Interest
data2015$SeedInterest <- factor(data2015$SeedInterest, levels = c("Not interested", "Somewhat interested", "Interested", "Very interested"))

# 2010 Seed Interest question was asked differently, can't be included
data2010 <- subset(data2010, select=-c(SeedInterest))

### Q29A - Q29H are factors in producers' decision NOT to purchase organic seed ----
# Drop 2010 data because the responses were framed differently
data2010 <- subset(data2010, select=-c(NoOGSeedTreat ,NoOGSeedProcessor, NoOGSeedQuant, NoOGSeedSave, NoOGSeedQual, NoOGSeedPrice, NoOGSeedVar, NoOGSeedTrait))

### 29A Lack of seed treatments, such as pelleting or priming ----
# Change non-responses to NA
data$NoOGSeedTreat <- ifelse (data$Q29A == "No answer" | data$Q29A == "partial complete" | data$Q29A == "skipped due to branching", NA, data$Q29A)
# Order factors
data$NoOGSeedTreat <- factor(data$NoOGSeedTreat, levels = c("Not a factor", "Slight factor", "Moderate factor", "Significant factor"))

# 2015 data
# Order factors
data2015$NoOGSeedTreat <- factor(data2015$NoOGSeedTreat, levels = c("Not a reason", "Slight reason", "Moderate reason", "Significant reason"))

# Rename to match 2020 data
data2015$NoOGSeedTreat <- revalue(data2015$NoOGSeedTreat, c("Not a reason"="Not a factor", "Slight reason"="Slight factor", "Moderate reason"="Moderate factor", "Significant reason"="Significant factor"))

### 29B Processor (buyer) requires or supplies varieties that are not available organically ----
# Change non-responses to NA
data$NoOGSeedProcessor <- ifelse (data$Q29B == "No answer" | data$Q29B == "partial complete" | data$Q29B == "skipped due to branching", NA, data$Q29B)
# Order factors
data$NoOGSeedProcessor <- factor(data$NoOGSeedProcessor, levels = c("Not a factor", "Slight factor", "Moderate factor", "Significant factor"))

# 2015 data
# Order factors
data2015$NoOGSeedProcessor <- factor(data2015$NoOGSeedProcessor, levels = c("Not a reason", "Slight reason", "Moderate reason", "Significant reason"))

# Rename to match 2020 data
data2015$NoOGSeedProcessor <- revalue(data2015$NoOGSeedProcessor, c("Not a reason"="Not a factor", "Slight reason"="Slight factor", "Moderate reason"="Moderate factor", "Significant reason"="Significant factor"))

### 29C Insufficient quantity of seed ----
# Change non-responses to NA
data$NoOGSeedQuant <- ifelse (data$Q29C == "No answer" | data$Q29C == "partial complete" | data$Q29C == "skipped due to branching", NA, data$Q29C)
# Order factors
data$NoOGSeedQuant <- factor(data$NoOGSeedQuant, levels = c("Not a factor", "Slight factor", "Moderate factor", "Significant factor"))

# 2015 data
# Order factors
data2015$NoOGSeedQuant <- factor(data2015$NoOGSeedQuant, levels = c("Not a reason", "Slight reason", "Moderate reason", "Significant reason"))

# Rename to match 2020 data
data2015$NoOGSeedQuant <- revalue(data2015$NoOGSeedQuant, c("Not a reason"="Not a factor", "Slight reason"="Slight factor", "Moderate reason"="Moderate factor", "Significant reason"="Significant factor"))

### 29D Save my own seed ----
# Change non-responses to NA
data$NoOGSeedSave <- ifelse (data$Q29D == "No answer" | data$Q29D == "partial complete" | data$Q29D == "skipped due to branching", NA, data$Q29D)
# Order factors
data$NoOGSeedSave <- factor(data$NoOGSeedSave, levels = c("Not a factor", "Slight factor", "Moderate factor", "Significant factor"))

# 2015 data
# Order factors
data2015$NoOGSeedSave <- factor(data2015$NoOGSeedSave, levels = c("Not a reason", "Slight reason", "Moderate reason", "Significant reason"))

# Rename to match 2020 data
data2015$NoOGSeedSave <- revalue(data2015$NoOGSeedSave, c("Not a reason"="Not a factor", "Slight reason"="Slight factor", "Moderate reason"="Moderate factor", "Significant reason"="Significant factor"))

### 29E Distrust of organic seed quality ----
# Change non-responses to NA
data$NoOGSeedQual <- ifelse (data$Q29E == "No answer" | data$Q29E == "partial complete" | data$Q29E == "skipped due to branching", NA, data$Q29E)
# Order factors
data$NoOGSeedQual <- factor(data$NoOGSeedQual, levels = c("Not a factor", "Slight factor", "Moderate factor", "Significant factor"))

# 2015 data
# Order factors
data2015$NoOGSeedQual <- factor(data2015$NoOGSeedQual, levels = c("Not a reason", "Slight reason", "Moderate reason", "Significant reason"))

# Rename to match 2020 data
data2015$NoOGSeedQual <- revalue(data2015$NoOGSeedQual, c("Not a reason"="Not a factor", "Slight reason"="Slight factor", "Moderate reason"="Moderate factor", "Significant reason"="Significant factor"))

### 29F Price ----
# Change non-responses to NA
data$NoOGSeedPrice <- ifelse (data$Q29F == "No answer" | data$Q29F == "partial complete" | data$Q29F == "skipped due to branching", NA, data$Q29F)
# Order factors
data$NoOGSeedPrice <- factor(data$NoOGSeedPrice, levels = c("Not a factor", "Slight factor", "Moderate factor", "Significant factor"))

# 2015 data
# Order factors
data2015$NoOGSeedPrice <- factor(data2015$NoOGSeedPrice, levels = c("Not a reason", "Slight reason", "Moderate reason", "Significant reason"))

# Rename to match 2020 data
data2015$NoOGSeedPrice <- revalue(data2015$NoOGSeedPrice, c("Not a reason"="Not a factor", "Slight reason"="Slight factor", "Moderate reason"="Moderate factor", "Significant reason"="Significant factor"))

### 29G Specific variety not available as organic seed ----
# Change non-responses to NA
data$NoOGSeedVar <- ifelse (data$Q29G == "No answer" | data$Q29G == "partial complete" | data$Q29G == "skipped due to branching", NA, data$Q29G)
# Order factors
data$NoOGSeedVar <- factor(data$NoOGSeedVar, levels = c("Not a factor", "Slight factor", "Moderate factor", "Significant factor"))

# 2015 data
# Order factors
data2015$NoOGSeedVar <- factor(data2015$NoOGSeedVar, levels = c("Not a reason", "Slight reason", "Moderate reason", "Significant reason"))

# Rename to match 2020 data
data2015$NoOGSeedVar <- revalue(data2015$NoOGSeedVar, c("Not a reason"="Not a factor", "Slight reason"="Slight factor", "Moderate reason"="Moderate factor", "Significant reason"="Significant factor"))

### 29H Lack of desirable genetic traits ----
# Change non-responses to NA
data$NoOGSeedTrait <- ifelse (data$Q29H == "No answer" | data$Q29H == "partial complete" | data$Q29H == "skipped due to branching", NA, data$Q29H)
# Order factors
data$NoOGSeedTrait <- factor(data$NoOGSeedTrait, levels = c("Not a factor", "Slight factor", "Moderate factor", "Significant factor"))

# 2015 data
# Order factors
data2015$NoOGSeedTrait <- factor(data2015$NoOGSeedTrait, levels = c("Not a reason", "Slight reason", "Moderate reason", "Significant reason"))

# Rename to match 2020 data
data2015$NoOGSeedTrait <- revalue(data2015$NoOGSeedTrait, c("Not a reason"="Not a factor", "Slight reason"="Slight factor", "Moderate reason"="Moderate factor", "Significant reason"="Significant factor"))

### 30A  Seed companies should conduct testing and report rates of GE (GMO) crop contamination in organic and conventional seed ----
# Change non-responses to NA
data$GMOTesting <- ifelse (data$Q30A == "No answer" | data$Q30A == "partial complete" | data$Q30A == "skipped due to branching", NA, data$Q30A)
# Order factors
data$GMOTesting <- factor(data$GMOTesting, levels = c("Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"))

# 2015 Data
# Order factors
data2015$GMOTesting <- factor(data2015$GMOTesting, levels = c("Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"))

# 2010 Data
# Order factors
data2010$GMOTesting <- factor(data2010$GMOTesting, levels = c("Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"))

### 30B	The federal regulations that oversee GE crop (GMOs) approvals are adequate for protecting my organic farm product(s) from potential contamination by GE crops (GMOs) ----
# Change non-responses to NA
data$Regulations <- ifelse (data$Q30B == "No answer" | data$Q30B == "partial complete" | data$Q30B == "skipped due to branching", NA, data$Q30B)
# Order factors
data$Regulations <- factor(data$Regulations, levels = c("Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"))

# 2015 Data
# Order factors
data2015$Regulations <- factor(data2015$Regulations, levels = c("Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"))

# 2010 Data
# Order factors
data2010$Regulations <- factor(data2010$Regulations, levels = c("Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"))


### 30C	Unintentionally planting GE-contaminated seed on my farm puts at risk the integrity of my organic products ----
# Change non-responses to NA
data$RiskfromGMO <- ifelse (data$Q30C == "No answer" | data$Q30C == "partial complete" | data$Q30C == "skipped due to branching", NA, data$Q30C)
# Order factors
data$RiskfromGMO <- factor(data$RiskfromGMO, levels = c("Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"))

# 2015 Data
# Order factors
data2015$RiskfromGMO <- factor(data2015$RiskfromGMO, levels = c("Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"))

# 2010 Data
# Order factors
data2010$RiskfromGMO <- factor(data2010$RiskfromGMO, levels = c("Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"))


### 30D	Organic seed is important to the integrity of organic food production ----
# Change non-responses to NA
data$OGSeedOGIntegrity <- ifelse (data$Q30D == "No answer" | data$Q30D == "partial complete" | data$Q30D == "skipped due to branching", NA, data$Q30D)
# Order factors
data$OGSeedOGIntegrity <- factor(data$OGSeedOGIntegrity, levels = c("Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"))

# 2015 Data
# Order factors
data2015$OGSeedOGIntegrity <- factor(data2015$OGSeedOGIntegrity, levels = c("Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"))

# 2010 Data
# Order factors
data2010$OGSeedOGIntegrity <- factor(data2010$OGSeedOGIntegrity, levels = c("Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"))

### 30E	Varieties bred for organic production are important to the overall success of organic agriculture ----
data$OGVarietiesSuccess <- ifelse (data$Q30E == "No answer" | data$Q30E == "partial complete" | data$Q30E == "skipped due to branching", NA, data$Q30E)
# Order factors
data$OGVarietiesSuccess <- factor(data$OGVarietiesSuccess, levels = c("Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"))

# 2015 Data
# Order factors
data2015$OGVarietiesSuccess <- factor(data2015$OGVarietiesSuccess, levels = c("Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"))

# 2010 Data
# Order factors
data2010$OGVarietiesSuccess <- factor(data2010$OGVarietiesSuccess, levels = c("Strongly disagree", "Disagree", "Neutral", "Agree", "Strongly agree"))

### Convert Respondent ID to factor ----
data$RespID <- factor(data$RespID)

###############################################################################
###############################################################################
### Create additional global variables ----

# Add column of state abbreviations to data based on zipcode
getzipcode <- zipcode$state
names(getzipcode) <- zipcode$zip
data$state <- unname(getzipcode[as.character(data[,"Q04A"])])
data2015$state <- unname(getzipcode[as.character(data2015[,"Zip1"])])
data2010$state <- data2010$State

# Create weight and survey object for survey based on current total population of organic producers (14,217 as of 2020)
tot_pop <- 14217
data$weight <- length(data$RespID) / tot_pop

mydesign <-
  svydesign(
    ids = ~1 ,
    data = data ,
    weights = ~weight
  )

# Create weight and survey object for 2015 survey based on 2014 total population of organic producers (14,093)
tot_pop2015 <- 14093
data2015$weight <- length(data2015$RespondentID) / tot_pop

mydesign2015 <-
  svydesign(
    ids = ~1 ,
    data = data2015 ,
    weights = ~weight
  )

# Create weight and survey object for 2015 survey based on 2014 total population of organic producers (14,093)
tot_pop2010 <- 10903
data2010$weight <- length(data2010$RespondentID) / tot_pop

mydesign2010 <-
  svydesign(
    ids = ~1 ,
    data = data2010 ,
    weights = ~weight
  )

# Get sp type shape data for states
# Add column of abbreviations
data("us_states")
us_states$state <- state.abb[match(us_states$NAME,state.name)]

# Dropping HI and AK for now because it is so far from everything
# Will need a way to incorperate eventually
rownames(zipcode) <- zipcode$zip
zipcode$zip <- as.character(zipcode$zip)
data$zip <- data$Q04A
zips <- left_join(data[,c("Q04A","zip")], zipcode, by = "zip")
zips <- zips[zips$state != "HI",]
zips <- zips[zips$state != "AK",]

# 2015 zipcode wrangling
data2015$zip <- as.character(data2015$Zip1)
zips2015 <- left_join(data2015[,c("Zip1","zip")], zipcode, by = "zip")
zips2015 <- zips2015[zips2015$state != "HI",]
zips2015 <- zips2015[zips2015$state != "AK",]

# No zipcode data for 2010


# Get state data for gradient maps and convert to upper case
# Add column of abbreviations
states_map <- map_data("state")
states_map$region <- str_to_title(states_map$region)
states_map$state <- state.abb[match(states_map$region,state.name)]

### Scratch code for including HI and AK
# devtools::install_github("wmurphyrd/fiftystater")
#
# library(ggplot2)
# library(mapproj)
# library(fiftystater)
#
# crimes <- data.frame(state = tolower(rownames(USArrests)), USArrests)
#
# p <- ggplot(crimes, aes(map_id = state)) +
#   geom_map(aes(fill = Assault), map = fifty_states) +
#   expand_limits(x = fifty_states$long, y = fifty_states$lat) +
#   coord_map()
# p

### Load data prep from file to speed up initialization ----	
# save.image(file = "SOS.rda")	
#load("SOS.rda")

### Scratch code -- mapping code experiments
# states <- ne_states(country = "united states of america", returnclass = "sf")

# "spDataLarge" , "rnaturalearth", "rnaturalearthdata"
#install_or_load_pack(packages)
# install.packages("rnaturalearthhires", repos = "http://packages.ropensci.org", type = "source")

# ggplot(zips,aes(longitude,latitude)) +
#   geom_polygon(data=us,aes(x=long,y=lat,group=group),color='gray',fill=NA,alpha=.35)

# ggplot(data = us_states) +
#     geom_sf(colour = "black", fill = "white") +
#     geom_point(data = zips, mapping = aes(x = longitude, y = latitude), colour = "blue", shape=21) +
#   coord_sf(crs = st_crs(us_states), datum = NA) +
#   theme(
#     panel.grid = element_blank(),
#     line = element_blank(),
#     rect = element_blank(),
#     text = element_blank(),
#     plot.background = element_rect(fill = "white"))
# 
# ##
# 
# input<-list()
# input$state <- "WI"
# 
# if (input$state!="All") {
#   
#   full_name <- state.name[match(input$state,state.abb)]
#   filtered_states <- us_states[us_states$NAME==full_name,]
#   filtered_zips <- zips[zips$state==input$state,]
# } else {
#   filtered_states <- us_states
#   filtered_zips <- zips
# }
# 
# ggplot(data = filtered_states) +
#     geom_sf(colour = "black", fill = "white") +
#     geom_point(data = filtered_zips, mapping = aes(x = longitude, y = latitude), colour = "blue", shape=21) +
#   coord_sf(crs = st_crs(filtered_states), datum = NA) +
#   theme(
#     panel.grid = element_blank(),
#     line = element_blank(),
#     rect = element_blank(),
#     text = element_blank(),
#     plot.background = element_rect(fill = "white"))
# ##
# 
# state.name[match("NY",state.abb)]
# 
# CA <- us_states[us_states$NAME=="California",]
# CA_zip <- zips[zips$state=="CA",]
# 
# ggplot(data = CA) +
#     geom_sf(colour = "black", fill = "white") +
#     geom_point(data = CA_zip, mapping = aes(x = longitude, y = latitude), colour = "blue", shape=21) +
#   coord_sf(crs = st_crs(CA), datum = NA) +
#   theme(
#     panel.grid = element_blank(),
#     line = element_blank(),
#     rect = element_blank(),
#     text = element_blank(),
#     plot.background = element_rect(fill = "white"))


# install.packages("maps")
# library(maps)
# 
# rownames(zipcode) <- zipcode$zip
# zips<-zipcode[data$Q04A, 1:6]
# 
# us<-map_data('state')
# 
# ggplot(zips,aes(longitude,latitude)) +
#   geom_polygon(data=us,aes(x=long,y=lat,group=group),color='gray',fill=NA,alpha=.35)
# 
# map <- get_openstreetmap(bbox = c("left" = -125, "bottom" = 25.75, "right" = -67, "top" = 49))
# p <- ggmap(map)+geom_point(aes(x=longitude, y=latitude), data=zips, alpha=.5)
# print(p)
# ci <- confint(svyciprop(~vegpercent, design=subset(mydesign,state=="CA"), method="logit", na.rm=TRUE))
# 
# mean <- svymean(~vegpercent, design=subset(mydesign,state=="CA"), method="logit", na.rm=TRUE)
# 
# 
# svyby(~Q07AA, list(data$state=="IN"), mydesign, svymean,vartype="ci")

#input$state <- c("CA","OR")

###############################################################################
###############################################################################


### Filter function----

FilterData <- function(data) {
  
  # filter by state
  if (input$state == "All") {
    sub <- data 
  } else {
    sub <- subset(data,state %in% input$state) 
  }
  
  # filter by crop type
  if (input$crop_type == "all") {
    sub <- sub
  } else if (input$crop_type == "has_veg") {
    sub <- subset(sub, HasVeg)
  } else if (input$crop_type == "only_veg") {
    sub <- subset(sub, OnlyVeg)
  } else if (input$crop_type == "has_field") {
    sub <- subset(sub, HasField)
  } else if (input$crop_type == "only_field") {
    sub <- subset(sub, OnlyField)
  } else if (input$crop_type == "has_forage") {
    sub <- subset(sub, HasForage)
  } else if (input$crop_type == "only_forage") {
    sub <- subset(sub, OnlyForage)
  }
  
  return (sub)
  
}

### Graphing functions ----

### Function to generate map based on producer zip and selected states ----
MapPlot_internal <- function (input) {
  
  # Avoid red error message when nothing is selected for input$state by validating
  validate(need(input$state, 'Please choose a state.'))
  
  if (input$state=="All") {
    
    filtered_states <- us_states
    filtered_zips <- zips
    filtered_zips2015 <- zips2015
    
  # Filter zip code points and state shapes based on input$state
  } else {
    
    # full_name <- state.name[match(input$state,state.abb)]
    filtered_states <- us_states[us_states$state %in% input$state,]
    filtered_zips <- zips[zips$state %in% input$state,]
    filtered_zips2015 <- zips2015[zips2015$state %in% input$state,]
  }
  
  # Filter based on crop type
  if (input$crop_type == "has_veg") {
    
    filtered_states <- us_states
    filtered_zips <- zips
    filtered_zips2015 <- zips2015
    
  }
  # TODO: need to add filtering function based on crop type
  # Probably need to join lat, long data with full data_frame rather
  # than having a seperate zip data_frame like it is now
  # Also need to add forage crop options
  
# radioButtons("crop_type", "Crop Types Grown:",
#                c("All" = "all",
#                  "Vegetables and Other Crops" = "has_veg",
#                  "Only Vegetables" = "only_veg",
#                  "Field Crops and Other Crops" = "has_field",
#                  "Only Field Crops" = "only_field",
#                  "Forage Crops and Other Crops" = "has_forage",
#                  "Only Forage Crops" = "only_forage"))
  # 
  # if (input$crop_type == "has_veg") {
  #   
  #   filtered_zips <- zips[zips$state %in% input$state,]
  #   filtered_zips2015 <- zips2015[zips2015$state %in% input$state,]
  #   
  # }
  
  # ggplot of state shapes (goem_sf) and zip codes (goem_point)
  # shape=21 is open circle
  # coords_sf is set to get rid of longitude and latitude notations
  # theme is set to get rid of lines
  p <-  ggplot(data = filtered_states) +
    geom_sf(colour = "black", fill = "white") +
    coord_sf(crs = st_crs(filtered_states), datum = NA) +
    theme(
      panel.grid = element_blank(),
      line = element_blank(),
      rect = element_blank(),
      text = element_blank(),
      plot.background = element_rect(fill = "white"))

  # Fix coloring for grayscale
  if (input$color_palette == "grayscale") {
    
    # make outline black and fill according to year
    outline2020 <- "#000000"
    outline2015 <- "#000000"
    fill2020 <- COLOR_PALETTE[[input$color_palette]]$Y2020
    fill2015 <- COLOR_PALETTE[[input$color_palette]]$Y2015
    
  } else {
    
    # make outline according to year and fill empty
    outline2020 <- COLOR_PALETTE[[input$color_palette]]$Y2020
    outline2015 <- COLOR_PALETTE[[input$color_palette]]$Y2015
    fill2020 <- NA
    fill2015 <- NA
 
  }
  
  
  if (input$Y2015) {
    p <- p + geom_point(data = filtered_zips2015, mapping = aes(x = longitude, y = latitude), colour = outline2015, fill = fill2015, shape=21, size=3)
    }
  
  if (input$Y2020) {
  
    p <- p + geom_point(data = filtered_zips, mapping = aes(x = longitude, y = latitude), colour = outline2020, fill = fill2020, shape=21, size=3)
  }


plot (p)
   
}

# External function with caching	
MapPlot <- memoise(MapPlot_internal, cache = getShinyOption("cache"))


### Function to make box plots of question means and errors ----
BoxPlot_internal <- function (input, question, title, xlab, ylab) {
  
  # dummy variables for testing
# input <- list()
# input$state <- "All"
# input$Y2010 <- FALSE
# input$Y2015 <- TRUE
# input$Y2020 <- TRUE
# input$show_n <- TRUE
# question <-"FieldAcreage"
# input$crop_type <- "only_veg"
# input$color_palette <- "colorblind"
# title <- "test"
# xlab <- "test"
# ylab <- "test"
  
  # Avoid red error message when nothing is selected for input$state by validating
  validate(need(input$state, 'Please choose at least one state.'))
  validate(need(input$Y2010 | input$Y2015 | input$Y2020, 'Please choose at least one year.'))
  validate(need((!is.null(data[[question]]) & input$Y2020) |
                (!is.null(data2015[[question]]) & input$Y2015) |
                (!is.null(data2010[[question]]) & input$Y2010)
                , 'Data not available for this question for the year(s) selected'))
  
  # Empty summary dataframe to add year data to
  survey_summary <- data.frame (
      "year" = character(),
      "question" = integer(),
      "mean" = integer(),
      "CI" = integer(),
      "n" = integer()
    )
  
  # Empty color palette
  graph_color <- character()
  
  # code for 2010 data
  if (!is.null(data2010[[question]]) & input$Y2010) {
   
    # subset data based on input filters
    sub2010 <- FilterData(mydesign2010)

    # Compile mean, error and total number of responses
    survey_mean2010 <- svymean(as.formula(paste0("~",question)), sub2010, na.rm=TRUE)
    responses2010 <- sub2010$variables[question]
    n2010 <- length(responses2010[!is.na(responses2010)])

      # Create new data frame from compiled data for ggplot
    survey_summary2010 <- data.frame (
      "year" = "2010",
      "question" = question,
      "mean" = as.data.frame(survey_mean2010)$mean,
      "CI" = as.data.frame(survey_mean2010)[[question]]*1.96,
      "n" = n2010
    )
    survey_summary2010$summary_labels <- paste("n = ",survey_summary2010$n,sep="")
     
    # Add to overall summary dataframe
    survey_summary <- merge(survey_summary,survey_summary2010, all=TRUE)
      
    # Add color to graph_color
    graph_color <- c(graph_color, COLOR_PALETTE[[input$color_palette]]$Y2010)
  }
  
  # code for 2015 data
  if (!is.null(data2015[[question]]) & input$Y2015) {
   
    # subset data based on input filters
    sub2015 <- FilterData(mydesign2015)
    
    # Compile mean, error and total number of responses
    survey_mean2015 <- svymean(as.formula(paste0("~",question)), sub2015, na.rm=TRUE)
    responses2015 <- sub2015$variables[question]
    n2015 <- length(responses2015[!is.na(responses2015)])

      # Create new data frame from compiled data for ggplot
    survey_summary2015 <- data.frame (
      "year" = "2015",
      "question" = question,
      "mean" = as.data.frame(survey_mean2015)$mean,
      "CI" = as.data.frame(survey_mean2015)[[question]]*1.96,
      "n" = n2015
    )
    survey_summary2015$summary_labels <- paste("n = ",survey_summary2015$n,sep="")
     
    # Add to overall summary dataframe
    survey_summary <- merge(survey_summary,survey_summary2015, all=TRUE)
      
    # Add color to graph_color
    graph_color <- c(graph_color, COLOR_PALETTE[[input$color_palette]]$Y2015)
  }
  
  # code for 2020 data
  if (!is.null(data[[question]]) & input$Y2020) {
  
    # subset data based on input filters
    sub2020 <- FilterData(mydesign)
    
    # Compile mean, error and total number of responses
    survey_mean2020 <- svymean(as.formula(paste0("~",question)), sub2020, na.rm=TRUE)
    responses <- sub2020$variables[question]
    n2020 <- length(responses[!is.na(responses)])

    # Create new data frame from compiled data for ggplot
    survey_summary2020 <- data.frame (
      "year" = "2020",
      "question" = question,
      "mean" = as.data.frame(survey_mean2020)$mean,
      "CI" = as.data.frame(survey_mean2020)[[question]]*1.96,
      "n" = n2020
    )
  survey_summary2020$summary_labels <- paste("n = ",survey_summary2020$n,sep="")
  
  # Add to overall summary dataframe
  survey_summary <- merge(survey_summary,survey_summary2020, all=TRUE)
  
  # Add color to graph_color
  graph_color <- c(graph_color, COLOR_PALETTE[[input$color_palette]]$Y2020)
  
  }
  
# ggplot plots mean (goem_bar) and error (geom_errorbar)
# Mean and n are added onto bar via the two geom_text calls
# Adds labels for the title, x, and y axis based on inputted variables title, xlab, and ylab
# Currently the y axis is fixed at 1-100, should make that dynamic

  
## Scratch code to automatically wrap titles  
# font_size <- 10
# wrap_width <- ???plotsize?? / (font_size*ggplot2:::.pt)
  
# ggplot(df2, aes_string("V1")) +
# geom_bar() +
# scale_x_discrete(labels = function(x) stringr::str_wrap(x, width = wrap_width))
  
  validate(need(!is.null(survey_summary$mean), "Not enough data for plot with current filters"))
  
  p <- ggplot(survey_summary, aes(x=question, fill = year, y=mean)) +
    geom_bar(stat = "identity", color = "black", width = 0.3, position = position_dodge(width=0.9)) +
    geom_errorbar(alpha = 1, 
                  mapping = aes(x = question, ymin = mean-CI, ymax = mean+CI), 
                  position = position_dodge(width=0.9),  size=.75, width=.1) +
    scale_fill_manual(values = graph_color) +
    ylim(0,100) +
    geom_text(aes(label=round(mean,1), vjust=2), color="black", size=10, position = position_dodge(width = 0.9)) +
    theme_linedraw(base_size = BASESIZE) +
    labs(title = stringr::str_wrap(title, width = WRAPWIDTH),
        x = xlab, y = ylab) +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_blank())

  # Remove legend if only one year
  if (nrow(survey_summary) == 1) {
    p <- p +  theme(legend.position="none")
  }

  # Add n if checked
  if (input$show_n) {
    p <- p + geom_text(aes(label=summary_labels, vjust=4), color="black", size=LABELSIZE-1, position = position_dodge(width = 0.9))
  }

  plot(p)

}

# External function with caching	
BoxPlot <- memoise(BoxPlot_internal, cache = getShinyOption("cache"))
      
### Function to make box plot for responses that can be split into bins ----
BinPlot_internal <- function (input, question, title, xlab, ylab) {
  
# dummy variables for testing
# input <- list()
# input$state <- "All"
# input$Y2010 <- FALSE
# input$Y2015 <- TRUE
# input$Y2020 <- TRUE
# input$show_n <- TRUE
# question <-"VegiAcreage"
# input$crop_type <- "only_veg"
# input$color_palette <- "colorblind"
# title <- "test"
# xlab <- "test"
# ylab <- "test"
  
  # Avoid red error message when nothing is selected for input$state by validating
  validate(need(input$state, 'Please choose at least one state.'))
  validate(need(input$Y2010 | input$Y2015 | input$Y2020, 'Please choose at least one year.'))
  validate(need((!is.null(data[[question]]) & input$Y2020) |
                (!is.null(data2015[[question]]) & input$Y2015) |
                (!is.null(data2010[[question]]) & input$Y2010)
                  , 'Data not available for this question for the year(s) selected'))
  
    
  # Build empty dataframe to add year summary data to
  out <- data_frame(
    "summary" = integer(),
    "summary_low" = integer(),
    "summary_upp" = integer(),
    "n" = integer(),
    "summary_labels" = character(),
    "year" = character()
  )
  
  # Empty color palette
  graph_color <- character()
  
  # Code for 2010 data
  if (!is.null(data2010[[question]]) & input$Y2010) {
  
    # Remove missing data
    data2010 <- data2010[!is.na(data2010[question]),]
    
        # Filter by crop type
    if (input$crop_type == "all") {
      data2010 <- data2010
    } else if (input$crop_type == "has_veg") {
      data2010 <- subset(data2010, HasVeg)
    } else if (input$crop_type == "only_veg") {
      data2010 <- subset(data2010, OnlyVeg)
    } else if (input$crop_type == "has_field") {
      data2010 <- subset(data2010, HasField)
    } else if (input$crop_type == "only_field") {
      data2010 <- subset(data2010, OnlyField)
    } else if (input$crop_type == "has_forage") {
      data2010 <- subset(data2010, HasForage)
    } else if (input$crop_type == "only_forage") {
      data2010 <- subset(data2010, OnlyForage)
    } 
    
    if (nrow(data2010) >= MINIMUM_N) {
    
    mydesign2010 <- data2010 %>% as_survey_design(id = 1, weight  = weight)
    
    if (input$state == "All") {
        sub2010 <- mydesign2010
      } else {
        # Filter to input states
        sub2010 <- subset(mydesign2010,state %in% input$state)
      }
    }
    
    if (nrow(data2010) >= MINIMUM_N) {
      # Create summary data of means and confidence intervals for bins
      out2010 <- sub2010 %>%
        group_by_at(question) %>%
        summarize(summary = survey_mean(vartype = "ci"), n = unweighted(n())) %>%
        mutate(summary = summary * 100, summary_low = summary_low * 100, summary_upp = summary_upp * 100)
      out2010$summary_labels <- paste("n=",out2010$n,sep="")
      out2010$year <- "2010"

      # merge with overall summary
      out <- merge(out,out2010, all=TRUE)
    
      # Add color to graph_color
      graph_color <- c(graph_color, COLOR_PALETTE[[input$color_palette]]$Y2010)
    }
  }
  
  # Code for 2015 data
  if (!is.null(data2015[[question]]) & input$Y2015) {
  
    # Remove missing data
    data2015 <- data2015[!is.na(data2015[question]),]
    
        # Filter by crop type
    if (input$crop_type == "all") {
      data2015 <- data2015
    } else if (input$crop_type == "has_veg") {
      data2015 <- subset(data2015, HasVeg)
    } else if (input$crop_type == "only_veg") {
      data2015 <- subset(data2015, OnlyVeg)
    } else if (input$crop_type == "has_field") {
      data2015 <- subset(data2015, HasField)
    } else if (input$crop_type == "only_field") {
      data2015 <- subset(data2015, OnlyField)
    } else if (input$crop_type == "has_forage") {
      data2015 <- subset(data2015, HasForage)
    } else if (input$crop_type == "only_forage") {
      data2015 <- subset(data2015, OnlyForage)
    } 
    
    if (nrow(data2015) >= MINIMUM_N) {
      mydesign2015 <- data2015 %>% as_survey_design(id = 1, weight  = weight)
    
      if (input$state == "All") {
          sub2015 <- mydesign2015
      } else {
        # Filter to input states
        sub2015 <- subset(mydesign2015,state %in% input$state)
      }
    }
    
    if (nrow(data2015) >= MINIMUM_N) {
      # Create summary data of means and confidence intervals for bins
      out2015 <- sub2015 %>%
        group_by_at(question) %>%
        summarize(summary = survey_mean(vartype = "ci"), n = unweighted(n())) %>%
        mutate(summary = summary * 100, summary_low = summary_low * 100, summary_upp = summary_upp * 100)
      out2015$summary_labels <- paste("n=",out2015$n,sep="")
      out2015$year <- "2015"

      # merge with overall summary
      out <- merge(out,out2015, all=TRUE)
    
      # Add color to graph_color
      graph_color <- c(graph_color, COLOR_PALETTE[[input$color_palette]]$Y2015)
    }
  }
  
  # Code for 2020 data
    if (!is.null(data[[question]]) & input$Y2020) {
  
    # Remove missing data
    data <- data[!is.na(data[question]),]
    
        # Filter by crop type
    if (input$crop_type == "all") {
      data <- data
    } else if (input$crop_type == "has_veg") {
      data <- subset(data, HasVeg)
    } else if (input$crop_type == "only_veg") {
      data <- subset(data, OnlyVeg)
    } else if (input$crop_type == "has_field") {
      data <- subset(data, HasField)
    } else if (input$crop_type == "only_field") {
      data <- subset(data, OnlyField)
    } else if (input$crop_type == "has_forage") {
      data <- subset(data, HasForage)
    } else if (input$crop_type == "only_forage") {
      data <- subset(data, OnlyForage)
    } 
    if (nrow(data) >= MINIMUM_N) {
      mydesign2020 <- data %>% as_survey_design(id = 1, weight  = weight)
    
      if (input$state == "All") {
        sub2020 <- mydesign2020
      } else {
          # Filter to input states
        sub2020 <- subset(mydesign2020,state %in% input$state)
      }
    }
    
    if (nrow(data) >= MINIMUM_N) {
      # Create summary data of means and confidence intervals for bins
      out2020 <- sub2020 %>%
        group_by_at(question) %>%
        summarize(summary = survey_mean(vartype = "ci"), n = unweighted(n())) %>%
        mutate(summary = summary * 100, summary_low = summary_low * 100, summary_upp = summary_upp * 100)
      out2020$summary_labels <- paste("n=",out2020$n,sep="")
      out2020$year <- "2020"

      # merge with overall summary
      out <- merge(out,out2020, all=TRUE)
    
      # Add color to graph_color
      graph_color <- c(graph_color, COLOR_PALETTE[[input$color_palette]]$Y2020)
    }
  }
  
  # Check if there are enough data points to show
  validate(need(nrow(out) >= MINIMUM_N, "Not enough data for plot with current filters"))
  
  # ggplot of means (geom_bar) and error (geom_errorbar) for bins
  p <- ggplot(data = out, aes_string(x = question, y = "summary",  fill = "year")) +
    geom_bar(stat = "identity", color = "black", width = 0.8, position = position_dodge(width=0.9)) +
    geom_errorbar(alpha = 1, mapping = aes_string(question, ymin = "summary_low", ymax = "summary_upp",  fill = "year"), inherit.aes = FALSE, size=.75, width=.1, position = position_dodge(width=0.9)) +
#    ylim(0,100) +
    geom_shadowtext(aes(label=round(summary,0), vjust=-0.2), color="black", size=LABELSIZE-1, bg.color="white", position = position_dodge(width = 0.9)) +
    theme_linedraw(base_size = BASESIZE) +
    labs(title = stringr::str_wrap(title, width = WRAPWIDTH),
         x = xlab, y = ylab)  +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(axis.text.x = element_text(angle=45, hjust = 1)) +
    scale_fill_manual(values = graph_color)
  
  # Remove legend if only one year
  if (length(levels(as.factor(out$year))) == 1) {
    p <- p +  theme(legend.position="none")
  }
  
  if (input$show_n) {
    p <- p + geom_text(aes(label=summary_labels, vjust = -2.7), color="black", size=LABELSIZE-4, position = position_dodge(width=0.9))
  }
  
  plot(p)
  
}

# External function with caching	
BinPlot <- memoise(BinPlot_internal, cache = getShinyOption("cache"))

### Function to make gradient maps  ----
GradientMap_internal <- function (input, question, title, catlab, year) {

  # dummy data for testing
   # input <- list()
   # input$state <- c("AZ","CA","WA","OR","NV")
   # input$state <- c("All")
   # question <- "Q05aA"
   # catlab <- "Percent Vegetable Seed Used"
   # input$show_n <- TRUE
   # year="2020"
   # title = "Percent Vegetable Seed Used"
  
  validate(need(input$state, 'Please choose at least one state.'))
  
  if (year == "2010") {
    
    mapdata <- data2010[!is.na(data2010[question]),]
    
  } else if (year == "2015") {
    
    mapdata <- data2015[!is.na(data2015[question]),]
    
  } else if (year == "2020") {
    
    mapdata <- data[!is.na(data[question]),]
    
  }
  
  
  if (input$state=="All") {
    
    filtered_state_map <- states_map
    filtered_state_names <- state.name
    filtered_data <- mapdata[,c(question,"state")]
    
  # Filter zip code points and state shapes based on input$state
  } else {
    
    filtered_state_map <- states_map[states_map$state %in% input$state,]
    filtered_data <- mapdata[,c(question,"state")]
    filtered_data <- filtered_data[filtered_data$state %in% input$state,]

  }

  # Retrieve the states map data and merge with pounds data

  data_sum <- filtered_data %>%
    group_by(state) %>%
    summarise(mean = mean(.data[[question]]), n = n())

  seed_map <- left_join(filtered_state_map, data_sum, by = "state")

  # Create the map
  p <- ggplot(seed_map, aes(long, lat, group = group)) +
  geom_polygon(aes(fill = mean), color = "grey50") +
  coord_sf(crs = st_crs(seed_map), datum = NA) +
  theme_linedraw(base_size = BASESIZE) +
  theme(
        panel.grid = element_blank(),
        line = element_blank(),
        rect = element_blank(),
        axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.text =  element_text(size = rel(0.5)),
        plot.background = element_rect(fill = "white")) +
  labs(title = stringr::str_wrap(title, width = WRAPWIDTH))
  
  # Add gradient colors
  # Scale white to black if grayscale, otherwise scale white to pallet color for the year
  if (year == "2010") {
  
    p <- p + scale_fill_gradient(low = "#ffffff", high = ifelse (input$color_palette == "grayscale", "#000000", COLOR_PALETTE[[input$color_palette]]$Y2010), na.value = "grey50", name = catlab)
    
  } else if (year == "2015") {
  
    p <- p + scale_fill_gradient(low = "#ffffff", high =  ifelse (input$color_palette == "grayscale", "#000000", COLOR_PALETTE[[input$color_palette]]$Y2015), na.value = "grey50", name = catlab) 
    
  } else if (year == "2020") {
  
    p <- p + scale_fill_gradient(low = "#ffffff", high =  ifelse (input$color_palette == "grayscale", "#000000", COLOR_PALETTE[[input$color_palette]]$Y2020), na.value = "grey50", name = catlab)
    
  }
  
  
  if (input$show_n) {

    n_label <- aggregate(cbind(long, lat) ~ state, data=seed_map,
                    FUN=function(x)mean(range(x)))

    n_label <- left_join(n_label, data_sum, by = "state")

    p <- p + theme (axis.title.x = element_text(hjust = 0)) + geom_text(data = n_label, aes(long, lat, group = state, label = n)) + labs(x = "Number inside states indicates number of repondents")
    
  }
  
  plot(p)

}

# External function with caching	
GradientMap <- memoise(GradientMap_internal, cache = getShinyOption("cache"))

## Scratch code for interactive map
  # ggplot() + 
  # geom_polygon_interactive(data = seed_map, color = 'gray50',
  #                                   aes(x = long, y = lat, fill = q_mean, group = group,
  #                                       tooltip = sprintf("%s<br/>%s", q_mean, q_n))) +
#  geom_polygon_interactive(data = world_data, color = 'gray70', size = 0.1,
#                                    aes(x = long, y = lat, fill = Value, group = group, 
#                                        tooltip = sprintf("%s<br/>%s", mean,"% ,n=", n)))
  #geom_polygon_interactive(data = seed_map, aes(fill = q_mean,  tooltip = q_mean), color = "grey50") +
 # scale_fill_gradient(low = "lightblue", high = "darkblue", na.value = "grey50", name = catlab) +
 #  coord_sf(crs = st_crs(seed_map), datum = NA) +
 #  theme_linedraw(base_size = 30) +
 #  theme(
 #        panel.grid = element_blank(),
 #        line = element_blank(),
 #        rect = element_blank(),
 #        axis.text.x = element_blank(), 
 #        axis.text.y = element_blank(),
 #        axis.title.y = element_blank(),
 #        axis.title.x = element_blank(),
 #        plot.title = element_text(hjust = 0.5),
 #        legend.text = element_text(size= 7),
 #        plot.background = element_rect(fill = "white")) +
 #  labs(title = title)


## Scratch code for experimenting with survey summarizing, bin and box plots

#   BinPlot (input = input, question = "Q05_2_o_bin", title = "Acreage", xlab = paste0(input$state,"Organic Acreage"), ylab = "")
  

# input<-list()
# input$state <- "All"
# 
#       p <- BoxPlot (input = input, question = "Q05aA", title = "Percent Vegetable Acreage Planted To Organic Seed", xlab = paste0(input$state," Vegetable Acreage"), ylab = "Percentage")
#       print(p)
      
# survey_mean <- svymean(as.formula(paste0("~",question)), sub, na.rm=TRUE)
# responses <- sub$variables[question]
# n <- length(responses[!is.na(responses)])
      
# survey_summary <- data.frame (
#     "year" = "2020",
#     "question" = question,
#     "mean" = as.data.frame(survey_mean)$mean,
#     "CI" = as.data.frame(survey_mean)[[question]]*1.96,
#     "n" = n
#   )
  
# data <- data[!is.na(data$Q05_2_o_bin),]
#       
# mydesign <- data %>% as_survey_design(id = 1, weight  = weight)
# 
# # summ <- mydesign %>%
# #     group_by(Q05_2_o_bin) %>%
# #     summarize(proportion = survey_mean(proportion = TRUE, vartype = "se", prop_method = "logit"))
# #       
# # print(summ)
# 
# out <- mydesign %>%
#   group_by(Q05_2_o_bin) %>%
#   summarize(summary = survey_mean(vartype = "ci"), n = unweighted(n())) %>%
#   mutate(summary = summary * 100, summary_low = summary_low * 100, summary_upp = summary_upp * 100)
# 
# # ggplot(data = out, aes(x = Q05_2_o_bin, y = summary, ymin = summary_low, ymax = summary_upp)) +
# #   geom_col(stat = "identity", position = "dodge") +
# #   geom_errorbar(position = position_dodge(width = 0.9), width = 0.1) +
# #   geom_text(aes(y = 0, label = n), position = position_dodge(width = 0.9), vjust = -1)
#       
# 
# p<-ggplot(data = out, aes(x = Q05_2_o_bin, y = summary)) +
#   geom_bar(stat = "identity", fill="skyblue3", color = "black", width = 0.3) +
#   geom_errorbar(alpha = 1, mapping = aes(Q05_2_o_bin, ymin = summary_low, ymax = summary_upp), inherit.aes = FALSE, size=.75, width=.1) +
#   ylim(0,100) +
#   theme_linedraw(base_size = 30) +
#   theme(legend.position="none") +
#   # labs(title = title,
#   #       x = xlab, y = ylab) +
#  #   theme(plot.title = element_text(hjust = 0.5)) +
#     theme(axis.text.x=element_text(angle=45,hjust=1))
# 
# #Temp add p
# plot(p)

```

<img src="www/cropped-logo-header.png" style="position:absolute;top:25px;right:0px;width:200px;height:75px" />

# Introduction
<b>Welcome to the State Of Organic Seed Producer Survey interactive report.</b>

State of Organic Seed is a project of Organic Seed Alliance that monitors the status of organic seed in the US and provides a roadmap for increasing the diversity, quality, and integrity of organic seed available.

In 2020, we conducted a national survey of certified organic crop growers to assess their attitudes and perceptions regarding organic seed, their current use of organic seed, and any obstacles that restrict organic seed sourcing. The survey also asked which crops and traits should be prioritized through organic plant breeding programs. Many additional topics were covered in this survey. We conducted a survey in 2010 and 2015 that asked many of the same questions, allowing us to measure our progress over the last five and ten years. 

This interactive report presents, in graphical form, the results of the latest organic farmer survey. It allow you to look at the responses from all farmers, or to view the responses from specific states. 

This survey was conducted in conjunction with the Organic Farming Research Foundation with funding by the USDA Organic Research and Education Initiative.

# Filter

:::: {.box}
<details>
  <summary>Filter by states, years, and producer types</summary>
  
By default responses from all states are shown. To select a specific state or states, delete the "All" and select or enter the two-letter abbreviations of the states you want to view data for.
```{r, Filter, echo=FALSE}
selectInput("state", "State:", choices=c("All",sort(unique(data$state))), selected="All", multiple=TRUE)

checkboxInput("Y2020", "Display 2020 Data", TRUE)
checkboxInput("Y2015", "Display 2015 Data", TRUE)
checkboxInput("Y2010", "Display 2010 Data", TRUE)

# Commented out until all graphs have filtering for producer type
radioButtons("crop_type", "Crop Types Grown:",
               c("All" = "all",
                 "Vegetables and Other Crops" = "has_veg",
                 "Only Vegetables" = "only_veg",
                 "Field Crops and Other Crops" = "has_field",
                 "Only Field Crops" = "only_field",
                 "Forage Crops and Other Crops" = "has_forage",
                 "Only Forage Crops" = "only_forage"))

```
</details> 
::::

$~$

# Appearance

:::: {.box}
<details>
  <summary>Adjust the appearance of the graphs</summary>
```{r, ShowN, echo=FALSE}
checkboxInput("show_n", "Display response numbers", FALSE)

radioButtons("color_palette", "Color Palette:",
               c("Default" = "default",
                 "Colorblind friendly" = "colorblind",
                 "Grayscale" = "grayscale"))
```
</details> 
::::

<p><br>Graphs take a few moments to create. Thank you for your patience.</p>

$~$


# Farm Demographics

$~$

## Farm Locations

```{r, Map, echo=FALSE}
    renderPlot({
      
      MapPlot (input = input)
      
    }, height = PLOTHEIGHT)

```

$~$

## Year Certified

```{r, Years, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "YearsCertified_bin", title = "Years Certified", xlab = paste(paste(input$state,collapse = " "),"Years Certified"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Vegetable Producer

```{r, VegProducer, echo=FALSE}
    renderPlot({
    
       BoxPlot (input = input, question = "GrowVegis", title = "Percentage of Respondents who Produce Vegetables", xlab = "", ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Vegetable Acreage

```{r, VegAcre, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "VegiAcreage", title = "Vegetable Acreage", xlab = paste(paste(input$state,collapse = " "),"Vegetable Acreage"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Cover Crop Producer

```{r, CoverProducer, echo=FALSE}
    renderPlot({
    
       BoxPlot (input = input, question = "GrowCover", title = "Percentage of Respondents who Produce Cover Crops or Green Pasture", xlab = "", ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Cover Crop Acreage

```{r, CoverAcre, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "CoverAcreage", title = "Cover Crop Acreage", xlab = paste(paste(input$state,collapse = " "),"Cover Crop Acreage"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Field Crop Producer

```{r, FieldProducer, echo=FALSE}
    renderPlot({
    
       BoxPlot (input = input, question = "GrowField", title = "Percentage of Respondents who Produce Field Crops", xlab = "", ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Field Crop Acreage

```{r, FieldAcre, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "FieldAcreage", title = "Field Crop Acreage", xlab = paste(paste(input$state,collapse = " "),"Field Crop Acreage"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Forage Crop Producer

```{r, ForageProducer, echo=FALSE}
    renderPlot({
    
       BoxPlot (input = input, question = "GrowForage", title = "Percentage of Respondents who Produce Forage Crops", xlab = "", ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Forage Crop Acreage

```{r, ForageAcre, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "ForageAcreage", title = "Forage Crop Acreage", xlab = paste(paste(input$state,collapse = " "),"Forage Crop Acreage"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

# Organic Seed Usage

$~$

## Vegetable Seed Use

```{r, VegOGSeed, echo=FALSE}
    renderPlot({
    
      BoxPlot (input = input, question = "OGVegiSeed", title = "Percent Vegetable Acreage Planted To Organic Seed", xlab = paste(paste(input$state, collapse = " "),"Vegetable Acreage"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

    # Still leaves a space if not rendered, need to figure out how to fix

### Scratch example code to possible use
# output$unsized <- renderPlot({
#   partydata <- long_data %>%
#     filter(Partei == input$map.party & Jahr == as.Date(input$map.year, "%Y"))
#   g2g14@data <- old_geodata
#   g2g14@data <- merge(g2g14@data, partydata, by.x =  "GMDNR",by.y ="BFSNr")
# 
#   cols <- brewer.pal(5, "Purples")
#   brks <- seq(0,100,20)
#   colsForMap <- cols[findInterval(g2g14@data$Staerke, vec = brks[1:5])]
# 
#   plot(g2g14, col = colsForMap, border = "white")
#   legend("topleft", legend = levels(cut(g2g14@data$Staerke, brks)), fill = cols, border = "white", title = "Parteistrke in %")
# 
# })
# 
# renderUI({
#   plotOutput("unsized", height = 500, width = 500)
# })

 renderPlot({
    
       BinPlot (input = input, question = "OGVegiSeedBins", title = "Percent Vegetable Acreage Planted To Organic Seed", xlab = paste(paste(input$state,collapse = " "),"Percentage of vegetable acreage planted to organic seed"), ylab = "Percentage of repondents")
      
    }, height = PLOTHEIGHT)


renderPlot({
     if (input$Y2020) {
      GradientMap (input = input, question = "OGVegiSeed", title = "2020 Percent Vegetable Acreage Planted To Organic Seed", catlab =  "Percentage", year = "2020")
     }
})

renderPlot({
       if (input$Y2015) {
      GradientMap (input = input, question = "OGVegiSeed", title = "2015 Percent Vegetable Acreage Planted To Organic Seed", catlab =  "Percentage", year = "2015")
     }
})

renderPlot({
       if (input$Y2010) {
      GradientMap (input = input, question = "OGVegiSeed", title = "2010 Percent Vegetable Acreage Planted To Organic Seed", catlab =  "Percentage", year = "2010")
     }
})
```

$~$

## Cover Crop Seed Use

```{r, CoverOGSeed, echo=FALSE}
    renderPlot({
     BoxPlot (input = input, question = "OGCoverSeed", title = "Percent Cover Crop Acreage Planted To Organic Seed", xlab = paste(paste(input$state,collapse=" "),"Cover Crop Acreage"), ylab = "Percentage")
}, height = PLOTHEIGHT)

 renderPlot({
    
       BinPlot (input = input, question = "OGCoverSeedBins", title = "Percent Cover Crop Acreage Planted To Organic Seed", xlab = paste(paste(input$state,collapse = " "),"Percentage of cover crop acreage planted to organic seed"), ylab = "Percentage of repondents")
      
    }, height = PLOTHEIGHT)

    renderPlot({
      if (input$Y2020) {
      GradientMap (input = input, question = "OGCoverSeed", title = "2020 Percent Cover Crop Acreage Planted To Organic Seed", catlab =  "Percentage", year = "2020")
      }
    })

renderPlot({
      if (input$Y2015) {
      GradientMap (input = input, question = "OGCoverSeed", title = "2015 Percent Vegetable Acreage Planted To Organic Seed", catlab =  "Percentage", year = "2015")
      }
    })

```

$~$

## Field Crop Seed Use

```{r, FieldOGSeed, echo=FALSE}
    renderPlot({
    
     BoxPlot (input = input, question = "OGFieldSeed", title = "Percent Field Crop Acreage Planted To Organic Seed", xlab = paste(paste(input$state,collapse=" "),"Field Crop Acreage"), ylab = "Percentage")
      
}, height = PLOTHEIGHT)

 renderPlot({
    
       BinPlot (input = input, question = "OGFieldSeedBins", title = "Percent Field Crop Acreage Planted To Organic Seed", xlab = paste(paste(input$state,collapse = " "),"Percentage of field crop acreage planted to organic seed"), ylab = "Percentage of repondents")
      
    }, height = PLOTHEIGHT)

    renderPlot({
      if (input$Y2020) {
        GradientMap (input = input, question = "OGFieldSeed", title = "2020 Percent Field Crop Acreage Planted To Organic Seed", catlab =  "Percentage", year = "2020")
      }
    })

renderPlot({
      if (input$Y2015) {
        GradientMap (input = input, question = "OGFieldSeed", title = "2015 Percent Field Crop Acreage Planted To Organic Seed", catlab =  "Percentage", year = "2015")
      }
    })

renderPlot({
      if (input$Y2010) {
        GradientMap (input = input, question = "OGFieldSeed", title = "2010 Percent Field Crop Acreage Planted To Organic Seed", catlab =  "Percentage", year = "2010")
      }
    })

```

$~$

## Forage Crop Seed Use

```{r, ForageOGSeed, echo=FALSE}
    renderPlot({
    
     BoxPlot (input = input, question = "OGForageSeed", title = "Percent Forage Crop Acreage Planted To Organic Seed", xlab = paste(paste(input$state,collapse=" "),"Forage Crop Acreage"), ylab = "Percentage")
      
}, height = PLOTHEIGHT)

 renderPlot({
    
       BinPlot (input = input, question = "OGForageSeedBins", title = "Percent Forage Crop Acreage Planted To Organic Seed", xlab = paste(paste(input$state,collapse = " "),"Percentage of forage crop acreage planted to organic seed"), ylab = "Percentage of repondents")
      
    }, height = PLOTHEIGHT)

    renderPlot({
      if (input$Y2020) {
        GradientMap (input = input, question = "OGForageSeed", title = "2020 Percent Forage Crop Acreage Planted To Organic Seed", catlab =  "Percentage", year = "2020")
      }
    })

renderPlot({
      if (input$Y2015) {
        GradientMap (input = input, question = "OGForageSeed", title = "2015 Percent Forage Crop Acreage Planted To Organic Seed", catlab =  "Percentage", year = "2015")
      }
    })

renderPlot({
      if (input$Y2010) {
        GradientMap (input = input, question = "OGForageSeed", title = "2010 Percent Forage Crop Acreage Planted To Organic Seed", catlab =  "Percentage", year = "2010")
      }
    })

```

$~$

## Using All Organic Seed

```{r, AllOGSeed, echo=FALSE}
    renderPlot({
    
     BoxPlot (input = input, question = "AllOGSeed", title = "Percentage of Producers Using Only Organic Seed", xlab = paste(paste(input$state,collapse=" "),"Share of Producers"), ylab = "Percentage")
      
}, height = PLOTHEIGHT)

    renderPlot({
      if (input$Y2020) {
        
        GradientMap (input = input, question = "AllOGSeed", title = "Percentage of 2020 Producers Using Only Organic Seed", catlab =  "Percentage", year = "2020")
      
      }
    })
    
        renderPlot({
      if (input$Y2015) {
        
        GradientMap (input = input, question = "AllOGSeed", title = "Percentage of 2015 Producers Using Only Organic Seed", catlab =  "Percentage", year = "2015")
      
      }
    })
        
            renderPlot({
      if (input$Y2010) {
        
        GradientMap (input = input, question = "AllOGSeed", title = "Percentage of 2010 Producers Using Only Organic Seed", catlab =  "Percentage", year = "2010")
      
      }
    })

```

$~$

# Organic Seed Production

$~$

## Producers Currently Saving Own Seed

```{r, SeedProduction, echo=FALSE}
    renderPlot({
    
     BoxPlot (input = input, question = "SeedSourceOwn0or100", title = "Percentage of Producers Growing Their Own Seed", xlab = paste(paste(input$state,collapse=" "),"Share of Producers"), ylab = "Percentage")
      
}, height = PLOTHEIGHT)

    renderPlot({
      if (input$Y2020) {
        
        GradientMap (input = input, question = "SeedSourceOwn0or100", title = "Percentage of 2020 Producers Growing Their Own Seed", catlab =  "Percentage", year = "2020")
      
      }
    })
    
        renderPlot({
      if (input$Y2015) {
        
        GradientMap (input = input, question = "SeedSourceOwn0or100", title = "Percentage of 2015 Producers Growing Their Own Seed", catlab =  "Percentage", year = "2015")
      
      }
    })
        
            renderPlot({
      if (input$Y2010) {
        
        GradientMap (input = input, question = "SeedSourceOwn0or100", title = "Percentage of 2010 Producers Growing Their Own Seed", catlab =  "Percentage", year = "2010")
      
      }
    })

```

$~$

## Interest in Growing Organic Seed

```{r, SeedInterest, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "SeedInterest", title = "Are you interested in producing organic seed for commercial use at some point in the future?", xlab = paste(paste(input$state,collapse = " "),"Interest Level"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

# Factors in Not Purchasing Organic Seed

$~$

## Lack of Seed Treatments

```{r, NoOGSeedTreat, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "NoOGSeedTreat", title = "How much was lack of seed treatments (such as pelleting or priming) a factor in your decision NOT to purchase organic seed?", xlab = paste(paste(input$state,collapse = " "),"Factors"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Buyer Requires Variety Not Available As Organic

```{r, NoOGSeedProcessor, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "NoOGSeedProcessor", title = "How much was processor (buyer) requiring or supplying varieties that are not available organically a factor in your decision NOT to purchase organic seed?", xlab = paste(paste(input$state,collapse = " "),"Factors"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Insufficient Quantity of Seed

```{r, NoOGSeedQuant, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "NoOGSeedQuant", title = "How much was an insufficient quantity of seed a factor in your decision NOT to purchase organic seed?", xlab = paste(paste(input$state,collapse = " "),"Factors"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Save Own Seed

```{r, NoOGSeedSave, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "NoOGSeedSave", title = "How much was saving your own seed a factor in your decision NOT to purchase organic seed?", xlab = paste(paste(input$state,collapse = " "),"Factors"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Distrust of organic seed quality

```{r, NoOGSeedQual, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "NoOGSeedQual", title = "How much was distrust of organic seed quality a factor in your decision NOT to purchase organic seed?", xlab = paste(paste(input$state,collapse = " "),"Factors"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Price

```{r, NoOGSeedPrice, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "NoOGSeedPrice", title = "How much was price a factor in your decision NOT to purchase organic seed?", xlab = paste(paste(input$state,collapse = " "),"Factors"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Variety not available as organic seed

```{r, NoOGSeedVar, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "NoOGSeedVar", title = "How much was the inavailability of specific varieties in organic seed a factor in your decision NOT to purchase organic seed?", xlab = paste(paste(input$state,collapse = " "),"Factors"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Lack of desirable genetic traits

```{r, NoOGSeedTrait, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "NoOGSeedTrait", title = "How much was the lack of desirable genetic traits a factor in your decision NOT to purchase organic seed?", xlab = paste(paste(input$state,collapse = " "),"Factors"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

# Opinions on Genetic Engineering and Organic Seeds

$~$

## Company Testing for GE Contamination

```{r, GMOTesting, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "GMOTesting", title = "Seed companies should conduct testing and report rates of GE (GMO) crop contamination in organic and conventional seed", xlab = paste(paste(input$state,collapse = " "),"Sentiment"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Federal GE Crop Regulations.

```{r, Regulations, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "Regulations", title = "The federal regulations that oversee GE crop (GMOs) approvals are adequate for protecting my organic farm product(s) from potential contamination by GE crops (GMOs)", xlab = paste(paste(input$state,collapse = " "),"Sentiment"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## GE Risk For Organic

```{r, RiskfromGMO, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "RiskfromGMO", title = "Unintentionally planting GE-contaminated seed on my farm puts at risk the integrity of my organic products", xlab = paste(paste(input$state,collapse = " "),"Sentiment"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Organic Seed for Organic Integrity

```{r, OGSeedOGIntegrity, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "OGSeedOGIntegrity", title = "Organic seed is important to the integrity of organic food production", xlab = paste(paste(input$state,collapse = " "),"Sentiment"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```

$~$

## Organic Breeding for Success of Organic Farming

```{r, OGVarietiesSuccess, echo=FALSE}
    renderPlot({
    
       BinPlot (input = input, question = "OGVarietiesSuccess", title = "Varieties bred for organic production are important to the overall success of organic agriculture", xlab = paste(paste(input$state,collapse = " "),"Sentiment"), ylab = "Percentage")
      
    }, height = PLOTHEIGHT)

```
